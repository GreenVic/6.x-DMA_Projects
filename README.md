# DMA Projects

Здесь будут представлены демо-проекты работы с DMA

Заводить новый репозиторий под каждый простейший проект показалось не слишком разумным.

## DMA_ToDAC
Пример выводит сигнал в ЦАП посредством DMA по отсчетам таймера.

Помимо вывода сигнала, проект показывает, что для работы с DMA необходимо включать тактирование всех блоков SSP. Если этого не сделать, то прерывания DMA начинают генерироваться постоянно, еще до инициализации таймера и разрешения ему работать на DMA. При этом основная ветвь перестает исполняться, что демонстрируют два светодиода.

Оба светодиода зажигаются при старте инициализации и выключаются при окончании инициализации. Далее в основном цикле мигает только один светодиод, показывая что исполнение проходит штатно. При этом на выходе ЦАП осциллографом можно увидеть выводимый сигнал синуса. (Сигнал можно поменять если выбрать другую функцию рассчета сигнала в коде)

Баг активируется макроопределением BUG_SSPx_ACTIVATE. При этом загораются оба светодиода и останутся гореть, т.к. цикл инициализации прерывается непрерывными прерываниями от SSP.

Баг связан с тем, что при включении МК со стороны SSP к NVIC стоит активный сигнал запроса прерывания. При разрешении тактирования SSP этот сигнал запроса приходит в состояние, согласованное с регистром SSP в котором запрос на прерывание по умолчанию выключен. Поэтому включение тактирования SSP помогает избавиться от лишних прерываний от DMA.

Описание проекта статье - https://startmilandr.ru/doku.php/prog:dma:dma_todac

## 6.3 - DMA_TimerCAP
В примере канал 1 таймера 3 генерирует сигнал ШИМ, который перемычкой на демо-плате подается на вход канала 4 таймера 1. Канал DMA передает данные из регистра захвата в массив, из которого затем высчитывается средний период и выводится на экран LCD.

Кнопки UP/DOWN на плате позволяют регулировать период ШИМ, с тем, чтобы определить минимальных период сигнала, который может быть захвачен.

Кнопки LEFT/RIGHT регулируют отступ в массиве захваченных данных, из которых вычисляется период. Это необходимо, потому что при периоде ШИМ порядка 25 тиков частоты CPU в первых отсчетах массива иногда приходят неправильные данные. Возможно это связано с пересинхронизацией между DMA и таймером, при запуске нового цикла DMA.

Минимальный захваченный период ШИМ получился в 11 тактов.

Описание проекта статье - https://startmilandr.ru/doku.php/prog:dma:dma_timercap

## 6.4 - DMA_SPI_Slave

В примере происходит обмен 8-битными данными между двумя SPI расположенными на одной плате с максимальной скоростью.

SPI1 настроен как мастер, SPI2 - как ведомый. Скорость обмена выставлена максимальная - 128МГц/12. Скорость обмена CPU_CLK/12 - это ограничение со стороны ведомого.

  * Светодиод VD10 - Загорается при совпадении переданных данных.
  * Светодиод VD11 - Загорается при НЕ совпадении переданных данных.

Данные передаются циклически, поэтому для сброса текущего статуса используется кнопка Select, при удержании которой в нажатом состоянии светодиоды выключаются. При отпускании кнопки светодиоды отображают наличие успешных и не успешных обменов с момента последнего сброса статуса.

Подключение SPI на плате показано на картинке VE1_SPI_1_2.jpg

## 6.5 - DMA_ADC

Пример обработки приема дынных с АЦП с помощью DMA.

Из особенностей для 1986ВЕ9х (и вероятно 1986ВЕ1Т/3Т):
  * Нет отдельного регистра отключающего запросы от АЦП к DMA. Как например в SSP. Поэтому запросы к DMA отключил через остановку непрерывных измерений - выкл бит Cfg_Reg_Sample.
  * Пока не вычитанное слово лежит в MDR_ADC->ADC1_RESULT запрос к DMA будет генерироваться, поэтому необходимо опустошить регистр результата после отключения преобразований. (Но вероятно может случиться так, что АЦП домеряет результат когда мы уже опустошим Result.)
  * На сколько понял из описания бит Go выставляется автоматически при работе в режиме sample, поэтому его тоже стоит погасить.

Для 1986ВЕ8Т отдельный проект, т.к. слишком много отличий. Читать значение ADC из регистра RESULT нельзя, при этом не сбрасывается запрос к DMA. Необходимо читать из регистров конкретного канала - RESULT[X].

